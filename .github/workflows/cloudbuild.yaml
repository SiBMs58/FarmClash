steps:
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/ua-ppdb-team3-414215/ua-ppdb-team3', '-f', '.github/workflows/Dockerfile', '.']
  
# Step to access the private SSH key from Secret Manager
- name: 'gcr.io/cloud-builders/gcloud'
  args:
        - 'secrets'
        - 'versions'
        - 'access'
        - 'latest'
        - '--secret=SSH-Passkey'
        - '--project=330455370908'  
  id: 'fetch-ssh-key'
  # Write the SSH key to a file
  env:
    - 'SSH_KEY_FILE=/workspace/ssh-key'

# Step to set correct permissions for the SSH key
- name: 'ubuntu'
  entrypoint: 'sh'
  args:
    - '-c'
    - |
      chmod 600 $$SSH_KEY_FILE
  env:
    - 'SSH_KEY_FILE=/workspace/ssh-key'

# Fetch the SSH key step here
- name: 'ubuntu'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo $$SSH_KEY > /tmp/ssh_key
      chmod 600 /tmp/ssh_key
      ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no USERNAME@SERVER_IP "COMMANDS_TO_RUN_ON_SERVER"
  env:
    - 'SSH_KEY=$_SECRETS_ENV_SSH_KEY'


images:
- 'gcr.io/ua-ppdb-team3-414215/ua-ppdb-team3'
